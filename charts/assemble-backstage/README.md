# ⚓️ Assemble Backstage Helm Deploy

The Assemble Backstage Helm Chart customizes and deploys the backstage backend application  written by Red Hat.

## Installing the chart

To install the chart, execute the following command:

```bash
# within this directory 
helm upgrade --install assemble-dev . -n assemble --create-namespace
```

## Configuration

The [values.yml](values.yaml) file contains instructions for common chart overrides.

The operator version can be configuring by modifying the operator configuration values. The startingCSV could be different based on the openshift cluster version.  The channel can be latest, stable or a specific version.

### Postgres Database Configuration

A container version of postgresql will be deployed along with the assemble-backstage application when the external flag is 'false'.  You can
 supply a database password or a random value can be used and stored in the postgres secret.  

Note: If you use the random password with tools like ArgoCd you could have passwords change due to re-generation of random values. In that case you should supply a password as part of setup.

```yaml
postgres:
  external: false
  database_user: postgres
  ## Password will be autogenerated if left empty
  ## If using extrnal instance supply the password
  #database_password: "somepassword"
  port: 5432
  image: registry.redhat.io/rhel9/postgresql-13:1-73
  resources:
    limits:
      cpu: 400m
      memory: 596Mi
    requests:
      cpu: 100m
      memory: 128Mi
```

### Backstage Configuration

There is a secret which contains the backstage `app-config.yaml` which can be modified using the following sample.

The 'catalog:' section will define the sources for configuring the catalog section of the app-config.yaml. This content will replace the yaml of that section of the configuration.  Refer to [Backstage Catalog Configuration](https://backstage.io/docs/features/software-catalog/configuration) for more details.  

```yaml
# backstage configuration
backstage:
  companyname: "My Company"
  baseUrl: 'https://<BACKSTAGE_HOST>'

  ## Override Catalog with here
  catalog:
    #import:
    #  entityFilename: /examples/catalog-info.yaml
    #  pullRequestBranchName: backstage-integration
    rules:
      - allow: [Component, System, API, Resource, Location]
    locations:
      # Local example data, file locations are relative to the backend process, typically `packages/backend`
      #- type: file
      #  target: /examples/entities.yaml

      # Local example template
      #- type: file
      #  target: /examples/template/template.yaml
      #  rules:
      #    - allow: [Template]

      # Local example organizational data
      #- type: file
      #  target: /examples/org.yaml
      #  rules:
      #    - allow: [User, Group]
```

### RHSSO

Red Hat Single Sign On (SSO) is integrated to act as a single source of identity. Several integrations are enabled by default, including the [Keycloak Backstage Plugin](https://github.com/janus-idp/backstage-plugins/tree/main/plugins/keycloak-backend).

The following values can be used to configure RHSSO with backend pluign support:

```yaml
rhsso:
  baseUrl: "https://<RHSSO_HOST>/auth"
  realm: backstage
  clientId: <CLIENT_ID>
  clientSecret: <CLIENT_SECRET>
  backstagePluginEnabled: true
```


### OAuth

By default, access to Backstage is not protected by any authentication or authorization. A OAuth proxy can be used to restrict access. An OAuth client must be created within an identity provider and made available to Helm during installation. 

The following values can be used to enable OAuth for backstage:

```yaml
oauth:
  enabled: true
```

## Removing

To delete the chart:

```bash
helm uninstall assemble-dev -n assemble
```
